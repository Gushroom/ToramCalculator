var A=Object.defineProperty;var $=(h,e,s)=>e in h?A(h,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[e]=s;var g=(h,e,s)=>$(h,typeof e!="symbol"?e+"":e,s);var C="info",t={setLevel(h){C=h},getLevel(){return C},info(h,...e){["info","debug"].includes(C)&&this._log("info",h,...e)},warn(h,...e){["warn","info","debug"].includes(C)&&this._log("warn",h,...e)},error(h,...e){["error","warn","info","debug"].includes(C)&&this._log("error",h,...e)},debug(h,...e){C==="debug"&&this._log("debug",h,...e)},_log(h,e,...s){let i="[LOG]",r=typeof window>"u"?"[SW]":"[MAIN]",a=new Date().toISOString(),n=`${i}${r}[${h.toUpperCase()}][${a}] ${e}`;switch(h){case"info":console.log(n,...s);break;case"warn":console.warn(n,...s);break;case"error":console.error(n,...s);break;case"debug":console.debug(n,...s);break}}};var E="2.1.0",d={ENABLED:!0,INTERVAL:18e5,MIN_INTERVAL:3e5,MAX_INTERVAL:864e5,BACKOFF_MULTIPLIER:1.5,MAX_BACKOFF:72e5},l={CORE:"core-"+E,ASSETS:"assets-"+E,DATA:"data-"+E,PAGES:"pages-"+E};var P=typeof import.meta<"u"&&import.meta.env&&import.meta.env.MODE==="development",u=()=>P,S=null,R=0,p=0,m=d.INTERVAL,b=class{static async loadChunkManifest(){t.info("\u5F00\u59CB\u8BFB\u53D6chunk\u6E05\u5355...");try{let e=await fetch("/chunk-manifest.json");if(!e.ok)return t.warn("\u65E0\u6CD5\u83B7\u53D6chunk-manifest.json"),{success:!1,error:"\u65E0\u6CD5\u83B7\u53D6chunk\u6E05\u5355"};let s=await e.json();if(t.info("\u{1F4E6} Chunk\u6E05\u5355\u8BFB\u53D6\u6210\u529F",{version:s.version,buildTime:s.buildTime,totalChunks:Object.keys(s.bundleInfo||{}).length}),t.info("\u{1F4CA} Chunk\u5206\u7C7B\u7EDF\u8BA1:",{core:s.chunks?.core?.length||0,routes:Object.keys(s.chunks?.routes||{}).length,features:Object.keys(s.chunks?.features||{}).length,workers:s.chunks?.workers?.length||0,vendors:s.chunks?.vendors?.length||0,assets:{images:s.assets?.images?.length||0,fonts:s.assets?.fonts?.length||0,others:s.assets?.others?.length||0}}),s.chunks?.core?.length>0&&t.info("\u{1F527} \u6838\u5FC3Chunks:",s.chunks.core.map(i=>({fileName:i.fileName,size:i.size,isEntry:i.isEntry}))),s.chunks?.routes){t.info("\u{1F6E3}\uFE0F \u8DEF\u7531Chunks:");for(let[i,r]of Object.entries(s.chunks.routes))t.info(`  ${i}:`,r.map(a=>a.fileName))}if(s.chunks?.features){t.info("\u2699\uFE0F \u529F\u80FDChunks:");for(let[i,r]of Object.entries(s.chunks.features))t.info(`  ${i}:`,r.map(a=>a.fileName))}return s.chunks?.workers?.length>0&&t.info("\u{1F477} Worker Chunks:",s.chunks.workers.map(i=>i.fileName)),s.chunks?.vendors?.length>0&&t.info("\u{1F4DA} Vendor Chunks:",s.chunks.vendors.map(i=>i.fileName)),s.assets&&t.info("\u{1F3A8} \u8D44\u6E90\u6587\u4EF6:",{images:s.assets.images?.slice(0,5)||[],fonts:s.assets.fonts?.slice(0,5)||[],others:s.assets.others?.slice(0,5)||[]}),t.info("\u{1F4CB} \u5B8C\u6574Bundle\u4FE1\u606F:",s.bundleInfo),{success:!0,manifest:s}}catch(e){return t.error("\u8BFB\u53D6chunk\u6E05\u5355\u5931\u8D25:",e),{success:!1,error:String(e)}}}static async checkChunkManifestVersion(){try{let e=await fetch("/chunk-manifest.json");if(!e.ok)return{hasChanged:!1};let s=await e.json(),i=JSON.stringify(s),r=null;try{let a=await fetch("/chunk-manifest.json");if(a.ok){let n=await a.json();r=JSON.stringify(n)}}catch(a){t.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524Dmanifest\u7F13\u5B58\uFF0C\u5C06\u91CD\u65B0\u52A0\u8F7D",a)}return r!==i?(t.info("\u68C0\u6D4B\u5230chunk\u6E05\u5355\u7248\u672C\u53D8\u5316",{oldVersion:r?"\u5DF2\u7F13\u5B58":"\u65E0\u7F13\u5B58",newVersion:s.buildTime||"\u672A\u77E5"}),{hasChanged:!0,manifest:s}):{hasChanged:!1,manifest:s}}catch(e){return t.warn("\u68C0\u67E5chunk\u6E05\u5355\u7248\u672C\u5931\u8D25:",e),{hasChanged:!1}}}},k=class k{static getInstance(){return k.instance||(k.instance=new k),k.instance}async cacheAllResources(){if(u()){t.info("[DEV] \u8DF3\u8FC7\u7F13\u5B58\u6240\u6709\u8D44\u6E90\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}t.info("\u5F00\u59CB\u667A\u80FD\u7F13\u5B58\u6240\u6709\u8D44\u6E90...");try{let{success:e,manifest:s}=await b.loadChunkManifest();if(e&&s){let i=null;try{let n=await fetch("/chunk-manifest.json");if(n.ok){let o=await n.json();i=JSON.stringify(o)}}catch(n){t.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524Dmanifest\u7F13\u5B58\uFF0C\u5C06\u91CD\u65B0\u52A0\u8F7D",n)}let r=[];s.chunks?.core&&r.push(...s.chunks.core.map(n=>`/${n.fileName}`)),r.push("/","/manifest.json");try{let n="/chunk-manifest.json";(await fetch(n)).ok?(r.push(n),t.info(`\u5DF2\u52A0\u5165\u6838\u5FC3\u7F13\u5B58: ${n}`)):t.warn(`manifest\u6587\u4EF6\u672A\u627E\u5230: ${n}`)}catch(n){t.warn("manifest\u6587\u4EF6\u8BF7\u6C42\u5F02\u5E38: /chunk-manifest.json",n)}await this.cacheCoreResources(r);let a=[];s.assets&&(s.assets.images&&a.push(...s.assets.images.map(n=>`/${n.fileName}`)),s.assets.fonts&&a.push(...s.assets.fonts.map(n=>`/${n.fileName}`)),s.assets.others&&a.push(...s.assets.others.map(n=>`/${n.fileName}`))),await this.cacheAssetResources(a),t.info("\u5206\u5C42\u7F13\u5B58\u5B8C\u6210",{core:r.length,assets:a.length})}else t.warn("\u65E0\u6CD5\u52A0\u8F7Dchunk\u6E05\u5355\uFF0C\u8DF3\u8FC7\u7F13\u5B58");t.info("\u667A\u80FD\u7F13\u5B58\u5B8C\u6210")}catch(e){throw t.error("\u667A\u80FD\u7F13\u5B58\u5931\u8D25:",e),e}}async cacheCoreResources(e){if(u()){t.info("[DEV] \u8DF3\u8FC7\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}if(e.length===0){t.warn("\u6CA1\u6709\u53D1\u73B0\u6838\u5FC3\u8D44\u6E90");return}t.info(`\u5F00\u59CB\u7F13\u5B58 ${e.length} \u4E2A\u6838\u5FC3\u8D44\u6E90...`);try{let s=await caches.open(l.CORE),i=[],r=[];for(let a of e)try{let n=await fetch(a);n.ok?(await s.put(a,n),i.push(a),t.info(`\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\u6210\u529F: ${a}`)):(r.push(a),t.warn(`\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\u5931\u8D25: ${a}`,{status:n.status}))}catch(n){r.push(a),t.error(`\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\u5F02\u5E38: ${a}`,n)}t.info("\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\u5B8C\u6210",{success:i.length,failed:r.length,total:e.length})}catch(s){t.error("\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\u5931\u8D25:",s)}}async cacheAssetResources(e){if(u()){t.info("[DEV] \u8DF3\u8FC7\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}if(e.length===0){t.warn("\u6CA1\u6709\u53D1\u73B0\u6784\u5EFA\u8D44\u6E90");return}t.info(`\u5F00\u59CB\u7F13\u5B58 ${e.length} \u4E2A\u6784\u5EFA\u8D44\u6E90...`);try{let s=await caches.open(l.ASSETS),i=[],r=[],a=10;for(let n=0;n<e.length;n+=a){let o=e.slice(n,n+a);await Promise.all(o.map(async c=>{try{let f=await fetch(c);f.ok?(await s.put(c,f),i.push(c),t.debug(`\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\u6210\u529F: ${c}`)):(r.push(c),t.warn(`\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\u5931\u8D25: ${c}`,{status:f.status}))}catch(f){r.push(c),t.error(`\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\u5F02\u5E38: ${c}`,f)}})),n+a<e.length&&await new Promise(c=>setTimeout(c,100))}t.info("\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\u5B8C\u6210",{success:i.length,failed:r.length,total:e.length})}catch(s){t.error("\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\u5931\u8D25:",s)}}async checkAndUpdateCache(){if(u()){t.info("[DEV] \u8DF3\u8FC7\u7F13\u5B58\u7248\u672C\u68C0\u67E5\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}t.info("\u68C0\u67E5\u7F13\u5B58\u7248\u672C...");let{hasChanged:e,manifest:s}=await b.checkChunkManifestVersion();if(e){t.info("\u68C0\u6D4B\u5230\u7248\u672C\u53D8\u5316\uFF0C\u5F00\u59CB\u66F4\u65B0\u7F13\u5B58...");let i=null;try{let r=await fetch("/chunk-manifest.json");if(r.ok){let a=await r.json();i=JSON.stringify(a)}}catch(r){t.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524Dmanifest\u7F13\u5B58\uFF0C\u5C06\u91CD\u65B0\u52A0\u8F7D",r)}await this.clearOldCaches(),await this.cacheAllResources(),t.info("\u7F13\u5B58\u66F4\u65B0\u5B8C\u6210")}else t.info("\u7F13\u5B58\u7248\u672C\u4E00\u81F4\uFF0C\u65E0\u9700\u66F4\u65B0")}async clearOldCaches(){if(u()){t.info("[DEV] \u8DF3\u8FC7\u6E05\u7406\u65E7\u7F13\u5B58\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}try{let s=(await caches.keys()).filter(r=>!Object.values(l).includes(r));s.length>0&&(t.info(`\u6E05\u7406 ${s.length} \u4E2A\u65E7\u7248\u672C\u7F13\u5B58:`,s),await Promise.all(s.map(r=>caches.delete(r))));let i=null;try{let r=await fetch("/chunk-manifest.json");if(r.ok){let a=await r.json();i=JSON.stringify(a)}}catch(r){t.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524Dmanifest\u7F13\u5B58\uFF0C\u5C06\u91CD\u65B0\u52A0\u8F7D",r)}if(i){let r=JSON.parse(i),a=new Set;r.chunks?.core&&r.chunks.core.forEach(n=>a.add(`/${n.fileName}`)),r.chunks?.routes&&Object.values(r.chunks.routes).forEach(n=>{n.forEach(o=>a.add(`/${o.fileName}`))}),r.chunks?.features&&Object.values(r.chunks.features).forEach(n=>{n.forEach(o=>a.add(`/${o.fileName}`))}),r.chunks?.vendors&&r.chunks.vendors.forEach(n=>a.add(`/${n.fileName}`)),r.chunks?.workers&&r.chunks.workers.forEach(n=>a.add(`/${n.fileName}`)),r.assets&&(r.assets.images&&r.assets.images.forEach(n=>a.add(`/${n.fileName}`)),r.assets.fonts&&r.assets.fonts.forEach(n=>a.add(`/${n.fileName}`)),r.assets.others&&r.assets.others.forEach(n=>a.add(`/${n.fileName}`)));for(let n of Object.values(l)){let o=await caches.open(n),c=await o.keys();for(let f of c){let I=new URL(f.url).pathname;!a.has(I)&&!this.isSpecialResource(I)&&(await o.delete(f),t.debug(`\u6E05\u7406\u8FC7\u671F\u8D44\u6E90: ${I}`))}}t.info("\u57FA\u4E8Emanifest\u7684\u7F13\u5B58\u6E05\u7406\u5B8C\u6210",{validResources:a.size})}}catch(e){t.error("\u6E05\u7406\u65E7\u7F13\u5B58\u5931\u8D25:",e)}}isSpecialResource(e){return["/","/manifest.json","/icons/","/favicon.ico"].some(i=>e.includes(i))}async getCacheStatus(){if(u())return t.info("[DEV] \u8DF3\u8FC7\u7F13\u5B58\u72B6\u6001\u83B7\u53D6\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09"),{core:!1,assets:new Map,data:new Map,pages:new Map,manifestVersion:"\u5F00\u53D1\u6A21\u5F0F",lastUpdate:new Date().toISOString()};t.debug("\u83B7\u53D6\u7F13\u5B58\u72B6\u6001...");let e={core:!1,assets:new Map,data:new Map,pages:new Map,manifestVersion:"\u5DF2\u7F13\u5B58",lastUpdate:new Date().toISOString()};try{let i=await(await caches.open(l.CORE)).keys();e.core=i.length>0;let a=await(await caches.open(l.ASSETS)).keys();for(let n of a){let o=n.url.split("/").pop()||n.url;e.assets.set(o,!0)}return t.info("\u7F13\u5B58\u72B6\u6001\u83B7\u53D6\u5B8C\u6210",e),e}catch(s){return t.error("\u83B7\u53D6\u7F13\u5B58\u72B6\u6001\u5931\u8D25:",s),e}}};g(k,"instance");var w=k,O=class{constructor(){g(this,"cacheManager",w.getInstance());g(this,"isRunning",!1)}startPeriodicCheck(){if(!d.ENABLED){t.info("\u5B9A\u671F\u68C0\u67E5\u5DF2\u7981\u7528");return}if(u()){t.info("[DEV] \u5F00\u53D1\u6A21\u5F0F\uFF1A\u8DF3\u8FC7\u5B9A\u671F\u68C0\u67E5");return}if(this.isRunning){t.warn("\u5B9A\u671F\u68C0\u67E5\u5DF2\u5728\u8FD0\u884C\u4E2D");return}this.isRunning=!0,t.info("\u{1F504} \u542F\u52A8\u5B9A\u671F\u7F13\u5B58\u68C0\u67E5",{interval:`${m/1e3/60}\u5206\u949F`,config:d}),this.scheduleNextCheck()}stopPeriodicCheck(){S&&(clearTimeout(S),S=null),this.isRunning=!1,t.info("\u23F9\uFE0F \u505C\u6B62\u5B9A\u671F\u7F13\u5B58\u68C0\u67E5")}scheduleNextCheck(){if(!this.isRunning)return;let e=Date.now()-R,s=Math.max(0,m-e);t.debug(`\u{1F4C5} \u5B89\u6392\u4E0B\u6B21\u68C0\u67E5: ${s/1e3}\u79D2\u540E`),S=setTimeout(async()=>{await this.performCheck(),this.scheduleNextCheck()},s)}async performCheck(){if(this.isRunning){t.info("\u{1F50D} \u6267\u884C\u5B9A\u671F\u7F13\u5B58\u68C0\u67E5..."),R=Date.now();try{await this.cacheManager.checkAndUpdateCache(),p>0&&t.info("\u2705 \u5B9A\u671F\u68C0\u67E5\u6210\u529F\uFF0C\u91CD\u7F6E\u5931\u8D25\u8BA1\u6570",{previousFailures:p,previousInterval:`${m/1e3/60}\u5206\u949F`}),p=0,m=d.INTERVAL,this.notifyClients("PERIODIC_CHECK_COMPLETED",{timestamp:new Date().toISOString(),success:!0,nextCheck:new Date(Date.now()+m).toISOString()})}catch(e){p++,t.error("\u274C \u5B9A\u671F\u68C0\u67E5\u5931\u8D25",{consecutiveFailures:p,error:String(e)}),this.applyBackoffStrategy(),this.notifyClients("PERIODIC_CHECK_FAILED",{timestamp:new Date().toISOString(),error:String(e),consecutiveFailures:p,nextCheck:new Date(Date.now()+m).toISOString()})}}}applyBackoffStrategy(){let e=Math.min(m*d.BACKOFF_MULTIPLIER,d.MAX_BACKOFF);m=Math.max(d.MIN_INTERVAL,Math.min(e,d.MAX_INTERVAL)),t.warn("\u23F0 \u5E94\u7528\u9000\u907F\u7B56\u7565",{consecutiveFailures:p,newInterval:`${m/1e3/60}\u5206\u949F`,maxBackoff:`${d.MAX_BACKOFF/1e3/60}\u5206\u949F`})}async performImmediateCheck(){if(u()){t.info("[DEV] \u5F00\u53D1\u6A21\u5F0F\uFF1A\u8DF3\u8FC7\u7ACB\u5373\u68C0\u67E5");return}t.info("\u26A1 \u6267\u884C\u7ACB\u5373\u7F13\u5B58\u68C0\u67E5..."),await this.performCheck()}getCheckStatus(){return{isRunning:this.isRunning,lastCheckTime:R,consecutiveFailures:p,currentInterval:m,nextCheckTime:R+m}}notifyClients(e,s){self.clients.matchAll().then(i=>{i.forEach(r=>{r&&"postMessage"in r&&r.postMessage({type:e,data:s})})}).catch(i=>{t.error("\u901A\u77E5\u5BA2\u6237\u7AEF\u5931\u8D25:",i)})}},v=class{constructor(){g(this,"cacheManager",w.getInstance())}async handleFetch(e){let s=new URL(e.request.url),i=s.pathname;if(u()||s.origin!==location.origin||e.request.method!=="GET")return;if(i==="/chunk-manifest.json"){e.respondWith((async()=>{let n=await caches.open(l.CORE),o=await n.match(e.request);if(o)return t.info(`\u79BB\u7EBF\u547D\u4E2D manifest: ${i}`),o;try{let c=await fetch(e.request);return c.ok&&(await n.put(e.request,c.clone()),t.info(`\u7F51\u7EDC\u7F13\u5B58 manifest: ${i}`)),c}catch{return t.warn(`manifest \u79BB\u7EBF\u4E14\u65E0\u7F13\u5B58: ${i}`),new Response("{}",{status:200,headers:{"Content-Type":"application/json"}})}})());return}if(i==="/"||i==="/index.html"){e.respondWith(caches.match(e.request).then(async n=>{if(n)return t.info(`\u79BB\u7EBF\u547D\u4E2D\u4E3B\u6587\u6863: ${i}`),n;try{let o=await fetch(e.request);return o.ok&&(await(await caches.open(l.CORE)).put(e.request,o.clone()),t.info(`\u7F51\u7EDC\u7F13\u5B58\u4E3B\u6587\u6863: ${i}`)),o}catch{return t.warn(`\u4E3B\u6587\u6863\u79BB\u7EBF\u4E14\u65E0\u7F13\u5B58: ${i}`),new Response("<!DOCTYPE html><title>\u79BB\u7EBF</title><h1>\u79BB\u7EBF\u4E0D\u53EF\u7528</h1>",{status:200,headers:{"Content-Type":"text/html"}})}}));return}await this.checkAndCacheManifestChunk(e,i);let r="\u7F51\u7EDC\u4F18\u5148",a="";if(this.isCoreResource(i)?(r="\u6838\u5FC3\u8D44\u6E90\u7F13\u5B58\u4F18\u5148",a=await this.cacheOrNetwork(e,l.CORE)):this.isAssetResource(i)?(r="\u6784\u5EFA\u8D44\u6E90\u7F13\u5B58\u4F18\u5148",a=await this.cacheOrNetwork(e,l.ASSETS)):this.isPageResource(i)?(r="\u9875\u9762\u7F13\u5B58\u4F18\u5148",a=await this.cacheOrNetwork(e,l.PAGES)):e.respondWith(fetch(e.request)),a&&a.includes("\u7F13\u5B58\u547D\u4E2D")){let n=this.getShortPath(i);t.info(i,`${e.request.method} ${n} -> ${r} (${a})`,e.request.url)}}async checkAndCacheManifestChunk(e,s){let i=null;try{let r=await fetch("/chunk-manifest.json");if(r.ok){let a=await r.json();i=JSON.stringify(a)}}catch(r){t.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524Dmanifest\u7F13\u5B58\uFF0C\u5C06\u91CD\u65B0\u52A0\u8F7D",r)}if(i)try{let r=JSON.parse(i),a=null,n="";if(r.chunks?.routes)for(let[o,c]of Object.entries(r.chunks.routes)){let f=c.find(y=>`/${y.fileName}`===s);if(f){a=f,n=`route:${o}`;break}}if(!a&&r.chunks?.features)for(let[o,c]of Object.entries(r.chunks.features)){let f=c.find(y=>`/${y.fileName}`===s);if(f){a=f,n=`feature:${o}`;break}}if(!a&&r.chunks?.vendors){let o=r.chunks.vendors.find(c=>`/${c.fileName}`===s);o&&(a=o,n="vendor")}if(!a&&r.chunks?.workers){let o=r.chunks.workers.find(c=>`/${c.fileName}`===s);o&&(a=o,n="worker")}if(a){t.debug(`\u53D1\u73B0manifest chunk: ${n} - ${a.fileName}`);let o=await caches.open(l.ASSETS);if(!await o.match(e.request))try{let f=await fetch(e.request);f.ok&&(await o.put(e.request,f.clone()),t.info(`\u52A8\u6001\u7F13\u5B58 ${n} chunk: ${a.fileName}`))}catch(f){t.warn(`\u52A8\u6001\u7F13\u5B58 ${n} chunk\u5931\u8D25: ${a.fileName}`,f)}}}catch(r){t.warn("\u68C0\u67E5manifest chunk\u5931\u8D25:",r)}}isCoreResource(e){return["/","/manifest.json","/icons/"].some(i=>e.includes(i))}isAssetResource(e){return["/_build/assets/",".js",".css",".ico",".png",".jpg",".jpeg",".gif",".svg",".woff",".woff2",".ttf"].some(i=>e.includes(i))}isPageResource(e){return!e.includes(".")&&!e.startsWith("/api/")&&e!=="/"}getShortPath(e){if(e.startsWith("/_build/")&&(e=e.substring(8)),e.includes("node_modules/")){let s=e.split("node_modules/");if(s.length>1){let r=s[1].match(/^([^/]+)\/(.+)$/);if(r){let a=r[1],n=r[2].split("/").pop()||"";return`\u{1F4E6} ${a}/${n}`}}}return e.startsWith("src/")?`\u{1F4C1} ${e}`:e.startsWith("db/")?`\u{1F5C4}\uFE0F ${e}`:e}async cacheOrNetwork(e,s){if(u())return"\u5F00\u53D1\u6A21\u5F0F\u8DF3\u8FC7\u7F13\u5B58";let i="";return e.respondWith(caches.match(e.request).then(async r=>{if(r)return i="\u7F13\u5B58\u547D\u4E2D",r;i="\u7F13\u5B58\u672A\u547D\u4E2D\uFF0C\u4ECE\u7F51\u7EDC\u83B7\u53D6";try{let a=await fetch(e.request);return a.ok&&(await(await caches.open(s)).put(e.request,a.clone()),i="\u5DF2\u7F13\u5B58\u7F51\u7EDC\u54CD\u5E94"),a}catch(a){t.warn("\u7F51\u7EDC\u8BF7\u6C42\u5931\u8D25\uFF0C\u5C1D\u8BD5\u4ECE\u7F13\u5B58\u83B7\u53D6",{url:e.request.url,error:a});let n=await caches.match(e.request);if(n)return i="\u4ECE\u7F13\u5B58\u83B7\u53D6\u6210\u529F",n;throw t.error("\u7F51\u7EDC\u548C\u7F13\u5B58\u90FD\u4E0D\u53EF\u7528",{url:e.request.url}),a}})),i}},N=class{constructor(){g(this,"cacheManager",w.getInstance());g(this,"periodicCheckManager",new O)}async handleMessage(e){let s=e.data;switch(t.info("\u6536\u5230\u5BA2\u6237\u7AEF\u6D88\u606F:",s),s.type){case"CHECK_CACHE_VERSION":t.info("\u68C0\u67E5\u7F13\u5B58\u7248\u672C\u6307\u4EE4"),e.waitUntil(this.handleCheckCacheVersion());break;case"CACHE_STATUS_REQUEST":t.info("\u7F13\u5B58\u72B6\u6001\u8BF7\u6C42"),e.waitUntil(this.handleCacheStatusRequest(e));break;case"FORCE_UPDATE":t.info("\u5F3A\u5236\u66F4\u65B0\u7F13\u5B58\u6307\u4EE4"),e.waitUntil(this.handleForceUpdate());break;case"CLEAR_CACHE":t.info("\u6E05\u7406\u7F13\u5B58\u6307\u4EE4"),e.waitUntil(this.handleClearCache());break;case"START_PERIODIC_CHECK":t.info("\u542F\u52A8\u5B9A\u671F\u68C0\u67E5\u6307\u4EE4"),e.waitUntil(this.handleStartPeriodicCheck());break;case"STOP_PERIODIC_CHECK":t.info("\u505C\u6B62\u5B9A\u671F\u68C0\u67E5\u6307\u4EE4"),e.waitUntil(this.handleStopPeriodicCheck());break;case"IMMEDIATE_CHECK":t.info("\u7ACB\u5373\u68C0\u67E5\u6307\u4EE4"),e.waitUntil(this.handleImmediateCheck());break;case"GET_CHECK_STATUS":t.info("\u83B7\u53D6\u68C0\u67E5\u72B6\u6001\u6307\u4EE4"),e.waitUntil(this.handleGetCheckStatus(e));break;case"SET_CONFIG":t.info("\u6536\u5230\u4E3B\u7EBF\u7A0B\u914D\u7F6E\u53D8\u66F4\u6307\u4EE4",s.data),this.handleSetConfig(s.data);break;default:t.warn("\u672A\u77E5\u6D88\u606F\u7C7B\u578B:",s.type)}}async handleCheckCacheVersion(){if(u()){t.info("[DEV] \u8DF3\u8FC7\u7F13\u5B58\u7248\u672C\u68C0\u67E5\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}try{await this.cacheManager.checkAndUpdateCache(),this.notifyClients("CACHE_UPDATED",{timestamp:new Date().toISOString()})}catch(e){t.error("\u7F13\u5B58\u7248\u672C\u68C0\u67E5\u5931\u8D25:",e)}}async handleCacheStatusRequest(e){if(u()){t.info("[DEV] \u8DF3\u8FC7\u7F13\u5B58\u72B6\u6001\u8BF7\u6C42\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}try{let s=await this.cacheManager.getCacheStatus();this.notifyClient(e.source,"CACHE_STATUS",s)}catch(s){t.error("\u83B7\u53D6\u7F13\u5B58\u72B6\u6001\u5931\u8D25:",s)}}async handleForceUpdate(){if(u()){t.info("[DEV] \u8DF3\u8FC7\u5F3A\u5236\u66F4\u65B0\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}try{await this.cacheManager.cacheAllResources(),this.notifyClients("FORCE_UPDATE_COMPLETED",{timestamp:new Date().toISOString()})}catch(e){t.error("\u5F3A\u5236\u66F4\u65B0\u5931\u8D25:",e)}}async handleClearCache(){if(u()){t.info("[DEV] \u8DF3\u8FC7\u6E05\u7406\u7F13\u5B58\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}try{let e=await caches.keys();await Promise.all(e.map(i=>caches.delete(i)));let s=null;try{let i=await fetch("/chunk-manifest.json");if(i.ok){let r=await i.json();s=JSON.stringify(r)}}catch(i){t.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524Dmanifest\u7F13\u5B58\uFF0C\u5C06\u91CD\u65B0\u52A0\u8F7D",i)}this.notifyClients("CACHE_CLEARED",{timestamp:new Date().toISOString()})}catch(e){t.error("\u6E05\u7406\u7F13\u5B58\u5931\u8D25:",e)}}handleSetConfig(e){try{if(typeof e!="object"||!e)return;typeof e.periodicCheckEnabled=="boolean"&&(d.ENABLED=e.periodicCheckEnabled,t.info("[SW][CONFIG] \u5DF2\u5E94\u7528\u5B9A\u671F\u68C0\u67E5\u5F00\u5173:",e.periodicCheckEnabled)),typeof e.periodicCheckInterval=="number"&&(d.INTERVAL=e.periodicCheckInterval,t.info("[SW][CONFIG] \u5DF2\u5E94\u7528\u5B9A\u671F\u68C0\u67E5\u95F4\u9694:",e.periodicCheckInterval)),typeof e.cacheStrategy=="string"&&t.info("[SW][CONFIG] \u5DF2\u5E94\u7528\u7F13\u5B58\u7B56\u7565:",e.cacheStrategy)}catch(s){t.error("[SW][CONFIG] \u5E94\u7528\u914D\u7F6E\u5931\u8D25:",s)}}notifyClients(e,s){self.clients.matchAll().then(i=>{i.forEach(r=>{r&&"postMessage"in r&&r.postMessage({type:e,data:s})})}).catch(i=>{t.error("\u901A\u77E5\u5BA2\u6237\u7AEF\u5931\u8D25:",i)})}notifyClient(e,s,i){e&&"postMessage"in e&&e.postMessage({type:s,data:i})}async handleStartPeriodicCheck(){try{this.periodicCheckManager.startPeriodicCheck(),this.notifyClients("PERIODIC_CHECK_STARTED",{timestamp:new Date().toISOString(),status:this.periodicCheckManager.getCheckStatus()})}catch(e){t.error("\u542F\u52A8\u5B9A\u671F\u68C0\u67E5\u5931\u8D25:",e)}}async handleStopPeriodicCheck(){try{this.periodicCheckManager.stopPeriodicCheck(),this.notifyClients("PERIODIC_CHECK_STOPPED",{timestamp:new Date().toISOString()})}catch(e){t.error("\u505C\u6B62\u5B9A\u671F\u68C0\u67E5\u5931\u8D25:",e)}}async handleImmediateCheck(){try{await this.periodicCheckManager.performImmediateCheck()}catch(e){t.error("\u7ACB\u5373\u68C0\u67E5\u5931\u8D25:",e)}}async handleGetCheckStatus(e){try{let s=this.periodicCheckManager.getCheckStatus();this.notifyClient(e.source,"CHECK_STATUS",s)}catch(s){t.error("\u83B7\u53D6\u68C0\u67E5\u72B6\u6001\u5931\u8D25:",s)}}};(async h=>{t.info("\u{1F680} \u667A\u80FD\u79BB\u7EBF\u4F18\u5148 Service Worker \u542F\u52A8"),t.info(`\u{1F527} \u8FD0\u884C\u6A21\u5F0F: ${P?"\u5F00\u53D1\u6A21\u5F0F":"\u751F\u4EA7\u6A21\u5F0F"}`);let e=w.getInstance(),s=new v,i=new N,r=new O;h.addEventListener("install",a=>{t.info("\u{1F4E6} Service Worker \u5B89\u88C5\u4E2D..."),a.waitUntil((async()=>{try{if(u()){t.info("\u{1F527} \u5F00\u53D1\u6A21\u5F0F\uFF1A\u8DF3\u8FC7\u8D44\u6E90\u7F13\u5B58\uFF0C\u4FDD\u6301\u70ED\u91CD\u8F7D\u80FD\u529B"),await h.skipWaiting(),t.info("\u2705 Service Worker \u5B89\u88C5\u5B8C\u6210\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}await e.cacheAllResources(),await h.skipWaiting(),t.info("\u2705 Service Worker \u5B89\u88C5\u5B8C\u6210")}catch(n){t.error("\u274C Service Worker \u5B89\u88C5\u5931\u8D25:",n)}})())}),h.addEventListener("activate",a=>{t.info("\u{1F504} Service Worker \u6FC0\u6D3B\u4E2D..."),a.waitUntil((async()=>{try{if(u()){t.info("\u{1F527} \u5F00\u53D1\u6A21\u5F0F\uFF1A\u8DF3\u8FC7\u7F13\u5B58\u6E05\u7406"),await h.clients.claim(),t.info("\u2705 Service Worker \u6FC0\u6D3B\u5B8C\u6210\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09");return}await e.clearOldCaches(),await h.clients.claim(),t.info("\u2705 Service Worker \u6FC0\u6D3B\u5B8C\u6210\uFF0C\u5DF2\u63A5\u7BA1\u6240\u6709\u5BA2\u6237\u7AEF"),r.startPeriodicCheck()}catch(n){t.error("\u274C Service Worker \u6FC0\u6D3B\u5931\u8D25:",n)}})())}),h.addEventListener("fetch",a=>{let n=new URL(a.request.url);if(!u()&&!(n.origin!==location.origin||a.request.method!=="GET")){if(n.pathname==="/chunk-manifest.json"){a.respondWith((async()=>{let o=await caches.open(l.CORE),c=await o.match(a.request);if(c)return t.info(`\u79BB\u7EBF\u547D\u4E2D manifest: ${n.pathname}`),c;try{let f=await fetch(a.request);return f.ok&&(await o.put(a.request,f.clone()),t.info(`\u7F51\u7EDC\u7F13\u5B58 manifest: ${n.pathname}`)),f}catch{return t.warn(`manifest \u79BB\u7EBF\u4E14\u65E0\u7F13\u5B58: ${n.pathname}`),new Response("{}",{status:200,headers:{"Content-Type":"application/json"}})}})());return}if(n.pathname==="/"||n.pathname==="/index.html"){a.respondWith(caches.match(a.request).then(async o=>{if(o)return t.info(`\u79BB\u7EBF\u547D\u4E2D\u4E3B\u6587\u6863: ${n.pathname}`),o;try{let c=await fetch(a.request);return c.ok&&(await(await caches.open(l.CORE)).put(a.request,c.clone()),t.info(`\u7F51\u7EDC\u7F13\u5B58\u4E3B\u6587\u6863: ${n.pathname}`)),c}catch{return t.warn(`\u4E3B\u6587\u6863\u79BB\u7EBF\u4E14\u65E0\u7F13\u5B58: ${n.pathname}`),new Response("<!DOCTYPE html><title>\u79BB\u7EBF</title><h1>\u79BB\u7EBF\u4E0D\u53EF\u7528</h1>",{status:200,headers:{"Content-Type":"text/html"}})}}));return}if(!n.pathname.includes(".")&&!n.pathname.startsWith("/api/")&&n.pathname!=="/"){a.respondWith(caches.match("/").then(o=>o?(t.info("App Shell \u79BB\u7EBF\u547D\u4E2D: /"),o):(t.warn("App Shell \u79BB\u7EBF\u672A\u547D\u4E2D: /"),fetch(a.request))));return}s.handleFetch(a)}}),h.addEventListener("message",a=>{i.handleMessage(a)}),h.addEventListener("error",a=>{t.error("\u274C Service Worker \u9519\u8BEF:",a.error)}),h.addEventListener("unhandledrejection",a=>{t.error("\u274C \u672A\u5904\u7406\u7684 Promise \u62D2\u7EDD:",a.reason)}),t.info("\u{1F389} \u667A\u80FD\u79BB\u7EBF\u4F18\u5148 Service Worker \u521D\u59CB\u5316\u5B8C\u6210\uFF0C\u7B49\u5F85\u4E8B\u4EF6...")})(self);export{w as CacheManager};
