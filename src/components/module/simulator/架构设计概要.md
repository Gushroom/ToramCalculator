# 计算引擎架构设计概要

## 核心需求
- 支持多配置并行DPS计算（如8个配置同时计算）
- 最大16个角色的战斗模拟
- 逐帧精确计算（60fps）
- 实时详细数据输出
- 基于事件驱动的游戏逻辑

## 整体架构

### 三层架构
```
主线程: XState UI状态管理 + Worker池调度
  ↓ (Comlink通信)
Worker池: 多个独立的完整模拟器实例
  ↓ (XState状态机)
Worker内: 事件驱动引擎 + 实时输出流
```

### 核心设计决策

#### 1. 多Worker并行策略
- **每个Worker = 完整独立模拟器**
- 无跨Worker数据交互（避免通信开销）
- Worker池动态管理（基于CPU核心数）
- 典型场景：8配置 = 8个Worker并行计算


### 1.2 整体架构

```
主线程 (Main Thread)
├── UI状态管理 (XState)
├── Worker池管理 (SimulatorPool)
└── 结果聚合展示

Worker池 (Worker Pool)
├── Worker1: 模拟器实例1 (配置A的DPS计算)
├── Worker2: 模拟器实例2 (配置B的DPS计算)
├── ...
└── Worker8: 模拟器实例8 (配置H的DPS计算)

每个Worker内部
├── 模拟器状态机 (XState)
├── 游戏引擎 (事件驱动)
├── 实时输出流 (详细数据)
└── 内存管理 (对象池)

#### 2. Worker内架构
- **XState状态机**：管理模拟器生命周期（初始化→运行→完成/取消）
- **事件驱动引擎**：保持原有old.worker.ts的设计思路
- **实时输出流**：批量发送帧数据，立即发送关键事件

#### 3. 执行模型
- **混合驱动**：帧循环 + 事件队列
- **完整计算**：每帧重算所有属性（响应式更新）
- **内存管理**：对象池 + 内存阈值控制

## 关键组件

### SimulatorPool（主线程）
- Worker生命周期管理
- 任务调度和负载均衡
- 内存阈值配置
- 实时进度聚合

### SimulatorWorker（Worker线程）
- XState模拟器状态机
- 事件驱动游戏引擎
- 详细数据输出流
- 内存池管理

### 数据流
```
配置配置 → Worker池分发 → 并行模拟 → 实时输出 → 结果聚合
```

## 性能考虑

### 优势
- 完美并行：8倍计算加速
- 无通信开销：每个模拟器自包含
- 充分利用多核CPU

### 约束
- 内存使用：每Worker ~50MB，总计400MB
- Worker数量：min(CPU核心数, 配置数量, 8)
- 实时性：批量输出平衡性能和实时性

## 扩展性
- 支持不同类型的并行计算任务
- 可配置的精确度和性能参数
- 状态机支持暂停/恢复/取消操作 